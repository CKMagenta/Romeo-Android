<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Insert title here</title>
<script src="lib/plugin/jquery-1.9.1.min.js"></script>
<script src="lib/plugin/json2.js"></script>
<script src="lib/plugin/underscore-min.js"></script>
</head>
<body>
<div id="rootNode" isunfolded="1" isroot="1"></div>
<script>

function test(str) {
	return "String : "+str+"!";
}

function nodeAtIndexPath(path) {
	// return node;
	console.log(path);
	return toJavaNode($('#rootNode div[indexPath="'+path+'"]'));
}

function count(node) {
	//return int 
	var $node = $('#rootNode div[indexPath="'+getIndexPath(node)+'"]');
	if(node.isRoot) {
		$node = $('#rootNode');
	}
	return ""+jqCount($node);
}

function jqCount(jqNode) {
	var result = 0;
	
	if(jqNode.attr('isUnfolded') == 1) {
		for(var i=0; i<jqNode.children().length; i++) {
			result += jqCount($(jqNode.children().get(i)));
		}
	} else if (jqNode.attr('isUnfolded') == 0) {
		//result +=1;
	}
	
	if(jqNode.attr("isRoot") != 1) {
		return result+1;
	} else {
		return result;
	}

}

function size(node) {
	//return int 
	return ""+$('#rootNode div[indexPath="'+getIndexPath(node)+'"]').children().length;
}

function setIndex(node, index) {
	var p = "";
	if(!node.parentIndexPath) p = node.parentIndexPath;
	$('#rootNode div[indexPath="'+getIndexPath(node)+'"]').attr("index", index).attr('indexPath', p+":"+index);
	return "SETINDEX";
}

function add(pNode, cNode) {
	var $node = null;
	var $pNode = null;
	if(pNode.isRoot == 1) {
		$pNode = $("#rootNode");
	} else {
		$pNode = $('#rootNode div[indexPath="'+getIndexPath(pNode)+'"]');
	}
	if( $pNode.attr('status') == 1) {
		$node = getNode(cNode).attr('status', 1);
	} else {
		$node = getNode(cNode).attr('status', 0);
	}
	
	if(!$node.attr('parentIndexPath')) {
		if(getIndexPath(pNode)!="-1") {
			$node.attr('parentIndexPath', getIndexPath(pNode));
			if($node.attr('indexPath')) {
				$node.attr('indexPath', getIndexPath(pNode)+":"+cNode.index);
			}
		}
	}
	
	$pNode.append($node);
	return "ADD";
}

function get(node, i) {
	var $node = null;
	if(node.isRoot == 1) {
		$node = $("#rootNode");
	} else {
		$node =  $('#rootNode div[indexPath="'+getIndexPath(node)+'"]');
	}
	
	var $target = $($node.children().get(i));
	return toJavaNode($target);
}

function getIndexPath(node) {
	var p = "";
	if(node.parentIndexPath) {
		p = node.parentIndexPath + ":";
	}
	return p+node.index;
}

function setIsUnfolded(node, unfolded) {
	$('#rootNode div[indexPath="'+getIndexPath(node)+'"]').attr('isUnfolded', unfolded);
	return "SETUNFOLDED";
}

function getNode(node) {
	$node = $('<div></div>').attr('status',0).attr('indexPath', getIndexPath(node)).attr('index',node.index).attr('isRoot',node.isRoot).attr('type',node.type).attr('isUnfolded',node.isUnfolded);
	if(node.parentIndexPath) {
		$node.attr('parentIndexPath',node.parentIndexPath);
	}
	return $node;
}

function toJavaNode(jqNode) {
	var isRoot = jqNode.attr('isRoot');
	var type	= jqNode.attr('type');
	var indexPath = jqNode.attr('indexPath');
	var parentIndexPath = jqNode.attr('parentIndexPath');
	var index = jqNode.attr('index');
	var isUnfolded = jqNode.attr('isUnfolded');
	var status = jqNode.attr('status');
	isRoot = (isRoot != undefined ? isRoot : "");
	type = (type != undefined ? type : "");
	indexPath = (indexPath != undefined ? indexPath : "");
	parentIndexPath = (parentIndexPath != undefined ? parentIndexPath : "");
	isRoot = (index != undefined ? index : "");
	
	var obj = { isRoot : isRoot, type:type, indexPath:indexPath, parentIndexPath:parentIndexPath, index:index, isUnfolded:isUnfolded, status:status};
	return JSON.stringify(obj);
	
}

function check(node) {
	var $node = $('#rootNode div[indexPath="'+getIndexPath(node)+'"]');
	var status = $node.attr('status');
	if(status ==1) {
		detParentStatusChecked($node);
		//$node.attr('status',0);
		$node.children().attr('status',0);
	} else {
		detParentStatusUnchecked($node);
		
		if($node.children().length >0) {
			$node.children().attr('status',1);
		}
	}
	return "CHECK";
}

function collect(node) {
	var $node = $('#rootNode div[status=1][type=1]');
	var indexPaths = [];
	for(var i = 0; i<$node.length; i++) {
		indexPaths.push($($node.get(i)).attr('indexpath'));
	}
	return indexPaths.join(" ");
	
}

function detParentStatusChecked(jqNode) {
	var result = 0;
	var $cs = jqNode.parent().children();
	for(var i=0; i<$cs.length; i++){
		var $c = $($cs.get(i));
		if($c.attr('indexPath') == jqNode.attr('indexPath')) continue;
		if($c.attr('status') != 0) result = 1;
	}
	
	if(result == 1) {
		if(jqNode.attr('isRoot')==1) return;
		jqNode.parents("[isRoot=0]").attr('status', 2);
		jqNode.attr('status',0);
	} else {
		if(jqNode.attr('isRoot')==1) return;
		jqNode.attr('status',0);
		detParentStatusChecked(jqNode.parent());
	}
}
function detParentStatusUnchecked(jqNode) {
	var result = 0;
	var $cs = jqNode.parent().children();
	for(var i=0; i<$cs.length; i++){
		var $c = $($cs.get(i));
		if($c.attr('indexPath') == jqNode.attr('indexPath')) continue;
		if($c.attr('status') != 1) result = 1;
	}
	
	if(result == 1) {
		if(jqNode.attr('isRoot')==1) return;
		jqNode.parents("[isRoot=0]").attr('status', 2);
		jqNode.attr('status', 1);
	} else {
		if(jqNode.attr('isRoot')==1) return;
		detParentStatusUnchecked(jqNode.parent());
		jqNode.attr('status',1);
	}
}

</script>
</body>
</html>